!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).RF=t()}(this,(function(){"use strict";return class{__callbacks=new Map;__sendQueue=[];__awaiting={};constructor(e=[]){this.__sendRaw=e=>this.__sendQueue.push(e),this.__readyState=0,this.__functions=new Map(e.map((e=>[e.name,async(...t)=>await this.__callFunc(e,t)])))}RFPrepare(e){return this.__sendRaw=e,this.__sendQueue.forEach((e=>this.__sendRaw(e))),this.__sendQueue=null,new Promise(((e,t)=>{2==this.__readyState?e():(this.__send("availableFuncs",Array.from(this.__functions.keys())),this.__readyIndicator={resolve:e,reject:t})}))}RFMessageReceived(e){e=JSON.parse(e),this.__dispatch(e.type,e.data)}__dispatch(e,t){({availableFuncs:()=>{t.forEach((e=>{this[e]=(...t)=>this.__callServerFunc(e,t)})),this.__send("funcsReceived",!0),this.__readyState++,2==this.__readyState&&(this.__readyIndicator.resolve(),delete this.__readyIndicator)},functionResult:()=>{this.__awaiting[t.reqId]&&(this.__awaiting[t.reqId][t.resultType](t.result),delete this.__awaiting[t.reqId])},error:()=>{console.error(t)},callClientCallback:()=>{let{id:e,args:s}=t,i=this.__callbacks.get(e);i&&i(...this.__deserializeArgs(s))},callClientFunc:()=>{let e=this.__functions.get(t.fname);e&&e(...this.__deserializeArgs(t.args)).then((e=>{this.__send("functionResult",{reqId:t.reqId,resultType:"resolve",result:e})})).catch((e=>{this.__send(JSON.stringify({type:"functionResult",data:{reqId:t.reqId,resultType:"reject",result:e.toString()}}))}))},funcsReceived:()=>{this.__readyState++,2==this.__readyState&&(this.__readyIndicator.resolve(),delete this.__readyIndicator)}})[e]()}__send(e,t){this.__sendRaw(JSON.stringify({type:e,data:t}))}__deserializeArgs(e){return e.map((e=>this.__deserializeArg(e)))}__deserializeArg(e){return"object"==typeof e&&{object:()=>this.__deserializeObject(e.data),function:()=>async(...t)=>{this.__callServerCallback(e.data,t)}}[e.type]()||e}__deserializeObject(e){return Object.entries(e).map(((e,t)=>this.__deserializeArg(t))).reduce(((e,t)=>({...e,[t[0]]:t[1]})),{})}__callServerCallback(e,t){this.__send(JSON.stringify({type:"callServerCallback",data:{id:e,args:this.__serializeArgs(t)}}))}__callServerFunc(e,t){return new Promise(((s,i)=>{let a=Math.random().toString(16).substr(2);this.__send("callFunc",{fname:e,args:this.__serializeArgs(t),reqId:a}),this.__awaiting[a]={resolve:s,reject:i}}))}__serializeArgs(e){return e.map(this.__serializeArg)}__serializeArg=e=>{let t=this,s={object:()=>({type:"object",data:t.__serializeObject(e)}),function:function(){return{type:"function",data:t.__registerCallback(e)}}}[typeof e];return s?s():e};__serializeObject(e){return Object.entries(e).map(((e,t)=>this.__serializeArg(t))).reduce(((e,t)=>({...e,[t[0]]:t[1]})),{})}__registerCallback(e){let t,s=Array.from(this.__callbacks.entries()).find((t=>{let[,s]=t;return e==s}));return s?[t]=s:(t=Math.random().toString(16).substr(2),this.__callbacks.set(t,e)),t}RFAddFunc(e){this.__functions.set(e.name,(async(...t)=>await this.__callFunc(e,t))),this.__send(JSON.stringify({type:"availableFuncs",data:Array.from(this.functions.keys())}))}async __callFunc(e,t){return new Promise((async(s,i)=>{try{s(await e(...t))}catch(e){i(e)}}))}}}));
